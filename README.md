# Ролевой Telegram Бот с Рассылками

Многофункциональный Telegram бот на Python, демонстрирующий ролевую модель доступа (администратор, модератор, пользователь) и продвинутую систему рассылок.

## Основной функционал

*   **Ролевая модель:**
    *   **Администратор:** Полный контроль над ботом, включая назначение ролей, просмотр статистики и запланированных рассылок.
    *   **Модератор:** Создание и планирование массовых рассылок для всех пользователей.
    *   **Пользователь:** Получение рассылок и стартового сообщения.
*   **Система рассылок:**
    *   Поддержка форматированного текста (HTML), изображений, видео и GIF.
    *   Возможность добавления кликабельных inline-кнопок (ссылок).
    *   Мгновенная отправка или планирование на конкретную дату и время.
    *   Автоматическое разбиение длинных сообщений.
    *   Отчет о результатах рассылки модератору.
*   **Удобный интерфейс:** Управление основными функциями происходит через Reply-кнопки.

## Технологии

*   **Python 3.10+**
*   **pyTelegramBotAPI (telebot)** - для взаимодействия с Telegram Bot API.
*   **aiomysql** - для асинхронной работы с базой данных MySQL.
*   **APScheduler** - для планирования отложенных задач (рассылок).
*   **python-dotenv** - для безопасного управления конфигурацией.

## Установка

1.  Клонируйте репозиторий:
    ```bash
    git clone https://адрес_вашего_репозитория.git
    cd telegram_bot
    ```
    или скачайте
    
3.  Установите все необходимые зависимости:
    ```bash
    pip install -r requirements.txt
    ```

## Настройка

Перед запуском бота необходимо настроить переменные окружения и базу данных.

1.  **Настройте базу данных:**
    *   Убедитесь, что у вас запущен сервер MySQL.
    *   Создайте новую базу данных. Например: `CREATE DATABASE telegram_bot_db;`

2.  **Создайте и заполните `.env` файл:**
    *   Скопируйте файл `.env.example` и переименуйте его в `.env`.
    *   Откройте `.env` и впишите ваши данные.

    **Пример `.env` файла:**
    ```
    # Обязательно: Токен вашего бота из @BotFather
    BOT_TOKEN=123456:ABC-DEF1234567890
    
    # Обязательно: ID пользователя, который станет главным администратором при первом запуске
    # Узнать свой ID можно у @userinfobot
    ADMIN_ID=123456789
    
    # --- Настройки базы данных ---
    DB_HOST=localhost
    DB_PORT=3306
    DB_USER=root
    DB_PASSWORD=your_secret_password
    DB_NAME=telegram_bot_db
    ```

## Запуск

После установки зависимостей и настройки `.env` файла, просто запустите главный скрипт:

```bash
python main.py
```

При первом запуске бот автоматически создаст необходимые таблицы в базе данных. Пользователь, чей ID указан в `ADMIN_ID`, получит права администратора при отправке команды `/start`.

## Логика работы

1.  **Инициализация:** При запуске `main.py` инициализируются бот, менеджер базы данных и система планирования рассылок (`APScheduler`). Бот подключается к БД и проверяет наличие запланированных, но еще не отправленных рассылок, чтобы поставить их в очередь.

2.  **Взаимодействие с пользователем:**
    *   При команде `/start` новый пользователь добавляется в базу данных с ролью `user`. Если ID пользователя совпадает с `ADMIN_ID`, ему присваивается роль `admin`.
    *   В зависимости от роли, пользователю отображается соответствующая клавиатура с доступными действиями.

3.  **Создание рассылки (Модератор/Админ):**
    *   Пользователь нажимает кнопку "✍️ Создать рассылку", запуская пошаговый диалог (машину состояний FSM).
    *   Диалог последовательно запрашивает текст (с HTML-разметкой), медиафайл, inline-кнопки и время отправки. На каждом шаге можно вернуться назад или отменить процесс.
    *   Перед отправкой пользователю показывается **превью** сообщения, чтобы он мог убедиться в корректности.
    *   После подтверждения данные о рассылке сохраняются в таблицу `mailings` в БД.

4.  **Отправка рассылки:**
    *   Если рассылка мгновенная, запускается асинхронная задача `process_mailing`.
    *   Если отложенная, `APScheduler` добавляет задачу в очередь на указанное время.
    *   В момент X `process_mailing` извлекает данные рассылки из БД, получает список всех `user_id` и начинает отправку сообщений.
    *   Текст автоматически разбивается на части (так как у сообщений с медиа и не только файлом 1024 символа, а у обычного текста 4096, то мы крайне вероятно захотим лимит как у обычного текста, достигнуть это можно тольков разбив сообщения на части: первое сообщение с медиафайлом и 1024 символов остальные 3072 будут в следующем сообщении уже простом без медиа отправлены), если он превышает лимиты Telegram.
    *   После завершения создателю рассылки приходит отчет с количеством доставленных/недоставленных сообщений и сколько секунд это заняло.
